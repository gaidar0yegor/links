# docker-compose.yml

version: '3.8'

services:
  # 1. Сервис для Telegram-бота
  bot:
    build: . # Собираем образ из Dockerfile в текущей директории
    container_name: affiliate_bot_app
    restart: unless-stopped
    depends_on:
      - redis
      - db
    env_file:
      - .env # Используем файл .env для переменных окружения (токен, ключи БД)
    volumes:
      # Для логирования и других временных файлов, если нужно
      - bot_logs:/app/logs

  # 2. Сервис для Redis (FSM Storage и Cache)
  redis:
    image: redis:7.2-alpine
    container_name: affiliate_bot_redis
    restart: unless-stopped
    ports:
      - "6379:6379" # Опционально: маппинг порта для локальной отладки

  # 3. Сервис для PostgreSQL (Campaigns, Timings, Stats)
  db:
    image: postgres:15-alpine
    container_name: affiliate_bot_db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Переменные для инициализации PostgreSQL. Должны совпадать с .env
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432" # Опционально: маппинг порта для локальной отладки
    volumes:
      # Сохраняем данные БД на хосте, чтобы они не терялись при перезапуске
      - postgres_data:/var/lib/postgresql/data/

# Объявление томов для персистентности данных
volumes:
  postgres_data:
  bot_logs:
